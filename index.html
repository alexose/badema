<!DOCTYPE html>
<html>
<head>
	<title>Sourcemap Leaflet GeoJSON example</title>
	
	<link rel="stylesheet" href="css/site.css" />
	<link rel="stylesheet" href="css/leaflet.css" />
	<link rel="stylesheet" href="css/jquery.slider.min.css" />
	<link href='http://fonts.googleapis.com/css?family=Quicksand:300,400' rel='stylesheet' type='text/css'>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script src="lib/leaflet-custom.js"></script>
	<script src="lib/underscore-min.js"></script>	
	<script src="lib/arc.js"></script>	
	<script src="lib/effects.js"></script>	
	<script src="lib/jquery.slider.min.js"></script>	
</head>
<body>
    <div id="config">
        <div id="loadcontrol" style="">
            http://www.sourcemap.com/services/supplychains/ <input type="text" id="smapid" style="width:30px;" value="822"/>
            Linestyle:
            <select id="linetype">
                <option value="st">Straight</option>
                <option value="gc">Great Circle</option>			
            </select>
            <input type="button" id="maptrigger" value="Go"></input> 
        </div>
    </div>
	<div id="map"></div>
    <div id="overlay">
        <div id="overlay-money" class="left">
            <span class="readout-small">$</span><span class="readout">0.00</span>
            <div class="slider"><input id="money-slider"></input></div>
        </div>
        <div id="overlay-result" class="right">
            <span class="readout-small">saves</span><span class="readout">0</span><span class="readout-small">kg co2e</span>
        </div>
        <div id="overlay-product">
            <span class="readout-small">Spent on</span><span class="readout">Laptop Computer</span>
            <div class="select">

            </div>
        </div>
        <div class="clear"></div>
    </div>
</div>
	<script>
    	$(document).ready(function() {						
			function addGeojson(id) {
				$.getJSON("http://dev.sourcemap.com/services/supplychains/"+id+"?f=geojson", function(data) {		
					var linetype = $("#linetype option:selected").val();
					if(linetype != "st") {	 
						for (var i = 0, len = data.features.length; i < len; i++) {
                            var npoints = 100;
							if(data.features[i].geometry.type == "LineString") {
                                var from = data.features[i].geometry.coordinates[0];
                                var to = data.features[i].geometry.coordinates[1];

								data.features[i].geometry.type = "MultiLineString";
								if(linetype == "gc"){
                                    var gc = new arc.GreatCircle({'x' : from[0], 'y' : from[1]},{'x' : to[0], 'y': from[1]});
                                    var multipass = gc.Arc(npoints);
                                }
                                var points = [];
                                for (i=0;i<npoints;i++){
                                    var c = multipass.coords[i];
                                    points.push(new L.LatLng(c[1], c[0]));
                                }
                                console.log(data);
                                data.features[i].geometry.coordinates = points;
                            }
						}
					}
					
					var geojsonLayer = new L.GeoJSON(null, {});		
					geojsonLayer.on("featureparse", function (e) {
						var title = "Unnamed."
						if(typeof(e.properties.title) != 'undefined') {
							title = e.properties.title;
						}
						var description = ""
						if(typeof(e.properties.description) != 'undefined') {
							description = e.properties.description;
						}
					
					    var popupContent = "<h2>"+title+"</h2><p>"+description+"</p>";
					    if (e.properties && e.properties.popupContent) {
					        popupContent += e.properties.popupContent;
					    }
					    e.layer.bindPopup(popupContent);
					    if (e.properties && e.properties.style && e.layer.setStyle) {
					        e.layer.setStyle(e.properties.style);
					    }
					});
					map.addLayer(geojsonLayer);
					geojsonLayer.addGeoJSON(data);
					geojsonLayer.setStyle({
						"color": "#237FD0",
						"weight": 3,
						"opacity": 0.4
					});
					
					var maptitle = '';
	
					layersControl.addOverlay(geojsonLayer, data.properties.title);
			  	});			
		 	}	
			
			var map = new L.Map('map');
			
			var cloudmadeUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/22677/256/{z}/{x}/{y}.png';
			var cloudmadeAttribution = 'Base data &copy; OSM contributors, Imagery &copy; CloudMade';
			var cloudmade = new L.TileLayer(cloudmadeUrl, {maxZoom: 18, attribution: cloudmadeAttribution});
			
			var bluemarbleUrl = 'http://{s}.tiles.mapbox.com/v3/mapbox.blue-marble-topo-bathy-jul-bw/{z}/{x}/{y}.png';
			var bluemarbleAttribution = 'NASA Blue Marble Topography from MapBox';
			var bluemarble = new L.TileLayer(bluemarbleUrl, {maxZoom: 8, attribution: bluemarbleAttribution});
				
			map.setView(new L.LatLng(0, 0), 2).addLayer(bluemarble).addLayer(cloudmade);
			var baseMaps = {
				"Cloudmade": cloudmade,
				"Bluemarble": bluemarble				
			};
			var layersControl = new L.Control.Layers(baseMaps, null);        
			map.addControl(layersControl);
			
		 	$("#maptrigger").click(function() {
			 	addGeojson($("#smapid").val());
			});
		
            // Add data overlay layers
            var solarLayer = new L.TileLayer.WMS('http://ec2-23-21-2-183.compute-1.amazonaws.com:8080/geoserver/gwc/service/wms',{
                layers: 'cleanweb:net_radiation_rgb_201106',
                format: 'image/png',
                transparent: true,
                opacity: 0.6,
                attribution: "Weather data Â© 2012 IEM Nexrad"
            }); 
            layersControl.addOverlay(solarLayer, "Dat Solar Data");

            map.attributionControl.setPrefix('<a href="http://www.sourcemap.com">Powered by Sourcemap</a> (Using Leaflet)');
			map.setView(new L.LatLng(0, 0), 2).locate({setView: true, maxZoom: 2});
			addGeojson($("#smapid").val());
      	});
	</script>
</body>
</html>
